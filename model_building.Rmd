---
title: "R Notebook"
output: html_notebook
---

```{r}
library(tidyverse)
library(pROC)
library(glmulti)
```

```{r}
all_EWR <- read_csv("clean_data/all_EWR.csv")
```

```{r}
all_EWR_log <- all_EWR %>% 
  select(month, weekday, hour, carrier, delayed, wind_dir, wind_speed, 
         wind_gust, visib, year, manufacturer) %>% 
  drop_na() %>% 
  mutate(month = factor(month, ordered = FALSE)) %>% 
  mutate(across(c(weekday, carrier, wind_dir, manufacturer), 
                ~as.factor(.x)))
```

```{r}
alias(delayed ~ ., data = all_EWR_log)
```

```{r}
all_EWR_log <- all_EWR_log %>% 
  select(-wind_gust)
```

```{r}
GGally::ggpairs(all_EWR_log %>% select(-manufacturer))
```

--------------------------------------------------------------------------------

# LOGISTIC REGRESSION

```{r}
glmulti_search_all_mains <- glmulti(
  delayed ~ ., 
  data = all_EWR_log,
  level = 1,               # No interactions considered, main effects only
  method = "h",            # Exhaustive approach
  crit = "bic",            # BIC as criteria
  confsetsize = 10,        # Keep 10 best models
  plotty = F, 
  report = T,              # No plots, but provide interim reports
  fitfunction = "glm",     # glm function
  family = binomial(link = "logit"))
```

Best model: delayed~1+month+weekday+carrier+wind_dir+hour+wind_speed+visib

```{r}
glmulti_search_previous_mains_one_pair <- glmulti(
  delayed ~ month + weekday + carrier + wind_dir + hour + wind_speed + visib, 
  data = all_EWR_log,
  level = 2,               # Interactions considered
  method = "h",            # Exhaustive approach
  crit = "bic",            # BIC as criteria
  confsetsize = 10,        # Keep 10 best models
  marginality = TRUE,      # consider pairs only if both main effects in model
  minsize = 8,             # minsize, maxsize and marginality here force 
  maxsize = 8,             # inclusion of a single pair beyond the five main effects
  plotty = F, 
  report = T,              # No plots, but provide interim reports
  fitfunction = "glm",     # glm function
  family = binomial(link = "logit")) # binomial family for logistic regression
```

Best model: delayed~1+month+weekday+carrier+hour+visib+weekday:month+carrier:hour

--------------------------------------------------------------------------------

# LINEAR REGRESSION

```{r}
all_EWR_lin <- all_EWR %>% 
  filter(dep_delay > 15) %>% 
  select(month, weekday, hour, dep_delay, carrier, wind_dir,
         wind_speed, visib, year, manufacturer) %>% 
  drop_na() %>% 
  mutate(month = factor(month, ordered = FALSE)) %>% 
  mutate(across(c(weekday, carrier, wind_dir, manufacturer), 
                ~as.factor(.x)))
```

```{r}
regsubsets_forward <- regsubsets(dep_delay ~ ., 
                                 data = all_EWR_lin,
                                 nvmax = 94,
                                 method = "forward")
```

```{r}
summary(regsubsets_forward)
```

```{r}
plot(regsubsets_forward, scale = "adjr2")
plot(regsubsets_forward, scale = "bic")
plot(summary(regsubsets_forward)$rsq, type = "b")
plot(summary(regsubsets_forward)$bic, type = "b")
```

```{r}
summary(regsubsets_forward)$which[12,]
```

```{r}
mod_1 <- lm(dep_delay ~ hour + wind_speed + visib, data = all_EWR_lin)
mod_month <- lm(dep_delay ~ hour + wind_speed + visib + month, 
                data = all_EWR_lin)
anova(mod_1, mod_month)
```

```{r}
mod_weekday <- lm(dep_delay ~ hour + wind_speed + visib + month + weekday, 
                data = all_EWR_lin)
anova(mod_month, mod_weekday)
```

```{r}
mod_carrier <- lm(dep_delay ~ hour + wind_speed + visib + 
                    month + weekday + carrier, 
                data = all_EWR_lin)
anova(mod_weekday, mod_carrier)
```

```{r}
mod_manufacturer <- lm(dep_delay ~ hour + wind_speed + visib + 
                    month + weekday + carrier + manufacturer, 
                data = all_EWR_lin)
anova(mod_carrier, mod_manufacturer)
```

```{r}
mod_wind_dir <- lm(dep_delay ~ hour + wind_speed + visib + month + 
                     weekday + carrier + manufacturer + wind_dir, 
                data = all_EWR_lin)
anova(mod_manufacturer, mod_wind_dir)
```

```{r}
summary(mod_wind_dir)
```
