---
title: "R Notebook"
output: html_notebook
---

```{r}
library(tidyverse)
```

```{r}
airlines_raw <- read_csv("data/airlines.csv")
airports_raw <- read_csv("data/airports.csv")
flights_raw <- read_csv("data/flights.csv")
planes_raw <- read_csv("data/planes.csv")
weather_raw <- read_csv("data/weather.csv")
```

```{r}
weather_raw %>%
  filter(origin == "EWR") %>% 
  summarise(across(.cols = everything(),
                   .fns = ~sum(!is.na(.x))/8735*100))
```

```{r}
flights_raw %>% 
  filter(origin == "EWR") %>% 
  dim()
```

```{r}
flights_raw %>% 
  filter(origin == "EWR") %>%
  group_by(year, month, day) %>% 
  count()
```

```{r}
airports_raw %>% 
  summarise(across(.cols = everything(),
                   .fns = ~sum(is.na(.x))))
```

```{r}
flights_raw %>% 
  summarise(across(.cols = everything(),
                   .fns = ~sum(is.na(.x))))
```

```{r}
planes_raw %>% 
  summarise(across(.cols = everything(),
                   .fns = ~sum(is.na(.x))))
```

```{r}
flights_raw %>% 
  filter(dest == "EWR")
```

--------------------------------------------------------------------------------

# CLEANING

```{r}
airlines <- airlines_raw %>% 
  rename("airline_name" = "name")
```

```{r}
airports <- airports_raw %>% 
  select(faa, name) %>% 
  rename("airport_name" = "name")
```

"The Federal Aviation Administration (FAA) considers a flight to be delayed when 
it is 15 minutes later than its scheduled time."

```{r}
flights <- flights_raw %>%
  select(month, day, hour, dep_delay, carrier, flight, 
         tailnum, origin, distance, time_hour) %>% 
  drop_na() %>% 
  arrange(month) %>% 
  mutate(delayed = if_else(dep_delay >= 15, TRUE, FALSE),
         weekday = weekdays(time_hour),
         month = lubridate::month(month, label = TRUE, abbr = FALSE))
```

```{r}
flights_EWR <- flights %>% 
  filter(origin == "EWR") %>% 
  select(-origin)
```

```{r}
planes <- planes_raw %>% 
  select(-speed)
```

```{r}
weather <- weather_raw %>% 
  select(-year, -month, -day, -hour)
```

```{r}
weather_EWR <- weather %>% 
  filter(origin == "EWR") %>% 
  select(-origin)
```

--------------------------------------------------------------------------------

# Joining 

```{r}
all <- flights %>% 
  left_join(airlines, by = "carrier") %>% 
  left_join(airports, by = c("origin" = "faa")) %>% 
  left_join(weather, by = c("time_hour", "origin")) %>% 
  left_join(planes, by = "tailnum")
```

```{r}
all_EWR <- flights_EWR %>% 
  left_join(airlines, by = "carrier") %>% 
  left_join(weather_EWR, by = "time_hour") %>% 
  left_join(planes, by = "tailnum")
```

--------------------------------------------------------------------------------

```{r}
write_csv(all_EWR, "clean_data/all_EWR.csv")
write_csv(all, "clean_data/all.csv")
```


